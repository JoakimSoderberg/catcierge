<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Catcierge by JoakimSoderberg</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Catcierge</h1>
          <h2>Image recognition (to keep cat prey out) and RFID chip reader system for automated DIY cat door.</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/JoakimSoderberg/catcierge/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/JoakimSoderberg/catcierge/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/JoakimSoderberg/catcierge" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/catcierge02.jpg" alt="Catcierge"></p>

<h1>
<a id="the-short-version" class="anchor" href="#the-short-version" aria-hidden="true"><span class="octicon octicon-link"></span></a>The short version</h1>

<p>The Catcierge project is an image recognition and cat RFID-chip reader for detecting cat prey and neighbour cats, made to work together with an automated cat door system. Designed for use with the Raspberry Pi including camera board (but can easily be modified to work on other systems as well).</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/short06.jpg" alt="Catcierge"></p>

<h1>
<a id="background" class="anchor" href="#background" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background</h1>

<p>The Catcierge project came about to solve the problem of our cat bringing home prey through the cat door. Instead of simply not allowing our cat to use the cat door anymore, like a normal person would, I of course set out to find a high-tech solution to solve my predicament.</p>

<p>My idea was to somehow use image recognition to lock the cat door if the cat had something in her mouth. My first idea was to use Haar Cascades as is normally used for facial recognition, but instead train it to work on cats.</p>

<p>In the process of researching possible solutions I found the <a href="http://www.quantumpicture.com/Flo_Control/flo_control.htm%5D">Flo Control</a> project that instead uses a controlled environment to get a good <strong>profile image</strong> of the cat where the prey easily can be distinguished. I decided to implement this idea instead.</p>

<h1>
<a id="development-story" class="anchor" href="#development-story" aria-hidden="true"><span class="octicon octicon-link"></span></a>Development story</h1>

<p>After replacing the window in our basement stairway with a cat door to let our cat Higgs live a more free roaming life, she soon started delivering dead (and some living) rodents and birds. Obviously this is not something we want so I decided to build an automated cat door that will shut her out when she tries to bring them inside.</p>

<p>When first installing the cat door we were also worried about other neighbouring cats making visits through it, since they sometimes visit through open doors in the summer. So I had some plans to create an automated door that solves that problem as well, by reading the RFID-chip Higgs has implanted in her neck.</p>

<p>I had seen several DIY solutions of RFID readers that require the cat to wear an extra RFID chip on a collar, but that's not what I wanted. So my idea was to find a reader that supports reading the actual <a href="http://en.wikipedia.org/wiki/ISO_11784_%26_11785">ISO 11784/11785, FDX/HDX tags</a> which uses another frequency compared to most generic RFID readers.</p>

<h2>
<a id="the-rapsberry-pi" class="anchor" href="#the-rapsberry-pi" aria-hidden="true"><span class="octicon octicon-link"></span></a>The <a href="http://www.raspberrypi.org/">Rapsberry Pi</a>
</h2>

<p>When I started thinking of this project the Raspberry Pi had become available, as well as the <a href="http://www.raspberrypi.org/archives/tag/camera-board">camera board</a>. So I quickly decided I will use this for my project. </p>

<p>One problem was that <a href="http://opencv.org/">OpenCV</a> does not work natively with the Raspberry Pi camera which interfaces directly via the CPU. Thankfully <a href="https://thinkrpi.wordpress.com/2013/05/22/opencv-and-camera-board-csi/">Pierre Raufast</a> fixed this problem by rewriting the raspistill program to work with OpenCV, and <a href="http://www.robidouille.com/">Emil Valkov</a> simplified this into a library that can easily be used with an API similar to the normal OpenCV camera API.</p>

<h2>
<a id="building-the-cat-door" class="anchor" href="#building-the-cat-door" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building the cat door</h2>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/catdoor01.jpg" alt="Cat door">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/catdoor02.jpg" alt="Cat door"></p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/catdoor03.jpg" alt="Cat door">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/catdoor04.jpg" alt="Cat door"></p>

<p>The cat door we built and installed as a replacement for our basement window was kind of a temporary solution. At first we had simply thought we would remove it for the winter and put the normal window back in since we live in northern Sweden where it easily can go down to -30C.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/cathouse01.jpg" alt="Cat house with extra corridor in front"></p>

<p>However, since I was thinking of building this automated cat door which obvisouly would need some extra space to fit, I instead decided to build a small house in front of the cat door that's insulated so we wouldn't loose too much heat through it as well.</p>

<p>My idea was to have the cat first go through a small corridor that I would build in front of this small cat house, and at the end of this corridor a first cat door would be installed. This would be the cat door that I could lock automatically if any prey was detected. </p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/cathouse02.jpg" alt="Cat corridor">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/cathouse03.jpg" alt="Cat corridor">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/cathouse04.jpg" alt="Cat corridor"></p>

<p>This design would also have the benefit of insulating the outside from the inside via two cat doors, instead of just one. I could also put in a third door at the beginning of this corridor to get even less cold air flowing in.</p>

<p>To make it easier to develop this thing, I built the corridor in a way that made it removable, so I could easily bring it in while developing the software and testing the door locking and such. I built the frame of it in place in front of the cat house, and made it fit into it's opening.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/corridor01.jpg" alt="Cat corridor">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/corridor04.jpg" alt="Cat corridor">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/corridor02.jpg" alt="Cat corridor">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/corridor03.jpg" alt="Cat corridor">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/corridor06.jpg" alt="Cat corridor"></p>

<p>The idea for this "capture" corridor was to keep the camera and electronics in half of it, and then make a small passage for the cat to actually go through in the other half. The corridor therefore needs to be wide enough so that the camera, with it's field of view, can get a good enough picture of the cats profile. </p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/corridor05.jpg" alt="Cat corridor"></p>

<p>The walls of the corridor that the cat walks through are made out of acrylic so that the camera can see through it. I made the roof out of plywood and placed it quite low so that she has to crouch when going in. This is so that the placement of the head against the background will be very consistent when taking the picture to match against. Also making the roof low makes it so her back rubs against the ceiling where the RFID readers will be located (she has the RFID chip in her neck).</p>

<p>To decide how far away the camera needed to be I persuaded my cat to keep still in front of the camera at different distances (not as easy as it sounds). The optimal distance turned out to be about 30cm. So I decided making the corridor 60cm would be enough to fit everything.</p>

<h2>
<a id="locking-mechanism" class="anchor" href="#locking-mechanism" aria-hidden="true"><span class="octicon octicon-link"></span></a>Locking mechanism</h2>

<p>The actual cat door I decided to use was a very simple store bought one with some manual plastic locking latches. I was not interested in using these for the actual locking, or buying some fancy expensive cat door with a built-in electronic locking mechanism.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/door01.jpg" alt="Locking"></p>

<p>Instead my idea all a long was to use a 12V solenoid that when given power will push a small pin out. This pin will then block the door so it cannot be opened. My first idea was to build my own circuit to control this solenoid via the 3.3v <a href="http://www.raspberrypi.org/">Raspberry Pi</a> GPIO pins. Since the solenoid requires a 12V power supply, it cannot be directly controlled via the GPIO pins.</p>

<p>After doing some googling, I instead found a nice and cheap board named <a href="http://www.piborg.com/picoborg">Picoborg</a> that lets you connect an external power supply (in my case a 12V one), and then control up to 4 devices using the RPI GPIO pins.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/locking01.jpg" alt="Locking"></p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/locking02.jpg" alt="Locking">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/locking03.jpg" alt="Locking"></p>

<p>To attach the solenoid next to the cat door I used my band saw to create a piece of wood that would hold it in place.</p>

<p><a href="http://www.youtube.com/watch?v=wViEUI-CRm8"><img src="http://img.youtube.com/vi/wViEUI-CRm8/0.jpg" alt="Video of locking mechanism"></a></p>

<p><a href="http://www.youtube.com/watch?v=wViEUI-CRm8">Youtube video</a></p>

<h2>
<a id="method-of-detecting" class="anchor" href="#method-of-detecting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Method of detecting</h2>

<p>Since I had found the <a href="http://www.quantumpicture.com/Flo_Control/flo_control.htm%5D">Flo Control project</a> that had solved the problem with detecting cat prey, I knew a working method in theory for how I could detect the cats face and eventual prey. </p>

<p>The basic idea is to make the cat go through a corridor. On one side of the corridor there's a camera, on the other side there's a backlight. This enables us to take a well controlled picture of the cats profile. Since cats keep their prey in the mouth, we can focus on the cats snout when doing the matching. We now use a saved image of the cats snout without any prey in it, and scan the image for that, if we get a good enough match, we can be certain the cat has no prey, if not we lock the door!</p>

<p>This method is a lot simpler than using more advanced techniques used for pattern matching, such as Haar Cascades or similar things normally used for facial detection in humans. Keep It Simple Stupid!</p>

<h2>
<a id="backlight" class="anchor" href="#backlight" aria-hidden="true"><span class="octicon octicon-link"></span></a>Backlight</h2>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight01.jpg" alt="Backlight"></p>

<p>Since the detection method I chose for this solution requires a backlight, I decided to use a 12V LED light that I then also can connect to the <a href="http://www.piborg.com/picoborg">Picoborg</a> and be able to control it via the RPI GPIO pins. First I tried using a normal LED light for this, but it turned out that the background would not be uniform enough, giving me a bad profile picture.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight02.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight03.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight04.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight05.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight06.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight07.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight09.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight10.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight08.jpg" alt="Backlight">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/backlight11.jpg" alt="Backlight"></p>

<p>Instead I decided to tape a cheap 5m LED light strip bought on ebay on to the back of some plywood to create one big backlight. By placing a piece of acrylic with some paper taped on to it in front of it, I got a more scattered and uniform light source.</p>

<h2>
<a id="rfid-readers" class="anchor" href="#rfid-readers" aria-hidden="true"><span class="octicon octicon-link"></span></a>RFID readers</h2>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/rfid02.jpg" alt="RFID"></p>

<p>Our cat has an RFID chip implanted in her neck for identification. This chip cannot be read using most generic RFID readers on the market, so I had to find one able to read the <a href="http://en.wikipedia.org/wiki/ISO_11784_%26_11785">ISO 11784/11785, FDX/HDX tags</a>.</p>

<p>The commercial products meant for veterinarians and the like are crazy expensive and not very customizeable to work in a scenario like mine. But eventually I found a great little company in Australia that creates cheap animal RFID readers for ease of use in DIY projects like this. I bought two of the <a href="http://www.priority1design.com.au/shopfront/index.php?main_page=product_info&amp;cPath=1&amp;products_id=23">FDX-B/HDX RFID Reader Writer with external antenna and USB port</a> readers.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/rfid03.jpg" alt="RFID"></p>

<p>My idea was to use two RFID antennas, one on each end of the corridor enabling me to detect in which direction the cat is going, in or out. As I mentioned earlier, I made the ceiling in the corridor quite low, so that the cats back will brush against it as she walks through. This way I can get the RFID chip to come as close to the readers as possible. My first idea was to simply have the antennas lying on top of this thin roof, since the readers specs says they can read at a distance of about 10cm.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/rfid01.jpg" alt="RFID"></p>

<p>However, from some testing it turns out I cannot read the tag unless I brush it against the cats skin, so doing it this way will not work. Most likely I could probably extend the range of the antenna by tuning it as specified in the datasheet, but this will be my last resort. In the mean time I'll try to put the antennas in a way that gives maximum contact with the cats neck.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/rfid04.jpg" alt="RFID"></p>

<p>The RFID readers don't come with the antenna soldered on, so I had to do that. Since the antenna wires are really thin, and it would be very easy to break the antenna, I made a small enclosure for them made out of some left over plastics from some blister packaging.</p>

<p>Here's some tests from reading the RFID tag of my cat:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/rfid05.jpg" alt="RFID"></p>

<h2>
<a id="software" class="anchor" href="#software" aria-hidden="true"><span class="octicon octicon-link"></span></a>Software</h2>

<p>When creating the matching algorithm as described above, I decided to first develop it as a prototype in the Python version of OpenCV, since this would enable me to use my laptop (a lot faster) instead of the Raspberry Pi.</p>

<p><a href="http://www.youtube.com/watch?v=1rPXvtY850c"><img src="http://img.youtube.com/vi/1rPXvtY850c/0.jpg" alt="Youtube video of higgs"></a></p>

<p><a href="http://www.youtube.com/watch?v=1rPXvtY850c">Youtube video of higgs</a></p>

<p>To test the matching I had to have some kind of input data to test against. Using some cat candy I managed to get Higgs to walk through the corridor while I had the raspivid program recording.</p>

<p>I then used frames from this video to create the matching algorithm. Here are the steps that the matching goes through to determine if Higgs has prey in her mouth or not:</p>

<h3>
<a id="ok" class="anchor" href="#ok" aria-hidden="true"><span class="octicon octicon-link"></span></a>OK</h3>

<p>Original image:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/ok/higgs02_01original.png" alt="Matching"></p>

<p>Turn the image into a grayscale image:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/ok/higgs02_02gray.png" alt="Matching"></p>

<p>Threshold the image (Every pixel above a certain value becomes black, and the others white) so that we get a binary image:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/ok/higgs02_03binary.png" alt="Matching"></p>

<p>We now remove some noise from the image:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/ok/higgs02_04nonoise.png" alt="Matching"></p>

<p>We now use a previously saved image of the cats snout and scan it over the image:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/snout/snout1080p.png" alt="Matching"></p>

<p>This creates a "heatmap" of where this snout image matches the best on the input image. The values of this image is between 0.0 and 1.0, so that the best match on the image has the highest value. We can use this maximum value to choose a threshold of how good a match we decide is a snout with no prey in it:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/ok/higgs02_05tempmatch.png" alt="Matching"></p>

<p>Finally we can mark on the original image where the best match was found:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/ok/higgs02_06final.png" alt="Matching"></p>

<h3>
<a id="not-ok" class="anchor" href="#not-ok" aria-hidden="true"><span class="octicon octicon-link"></span></a>Not OK</h3>

<p>To determine the threshold for the maximum value to consider a good match, we also need some images with a negative input. That is, an image of Higgs with a mouse or other dead animal in her mouth. Since I didn't have any real input data with this scenario yet, I simply drew a mouse in her mouth in an image.</p>

<p>Same steps as above but with a prey in her mouth:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/notok/higgsfel02_01original.png" alt="Matching"></p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/notok/higgsfel02_02gray.png" alt="Matching"></p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/notok/higgsfel02_03binary.png" alt="Matching"></p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/notok/higgsfel02_04nonoise.png" alt="Matching"></p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/notok/higgsfel02_05tempmatch.png" alt="Matching"></p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/notok/higgsfel02_06final.png" alt="Matching"></p>

<p>If we compare the two match maps we can easily see the difference:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/notok/higgsfel02_05tempmatch.png" alt="Matching">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/ok/higgs02_05tempmatch.png" alt="Matching"></p>

<p>The max value in the second image is lower since no good match can be found.</p>

<p>From some test with different input images I decided that a good threshold value as mentioned above is 0.8, on the 0.0 to 1.0 scale, where 1.0 would be a perfect match.</p>

<h2>
<a id="from-python-prototype-to-c-version" class="anchor" href="#from-python-prototype-to-c-version" aria-hidden="true"><span class="octicon octicon-link"></span></a>From Python prototype to C Version</h2>

<p>After creating my prototype in Python and getting it all to work, I then moved on to creating the same algorithm in a C library. I made it a library so that I can easily compile a test program to test only the algorithm on another platform than the Raspberry Pi. And then write a final program that is used for the actual image recognition running on the Raspberry Pi separately.</p>

<p>After writing the C verison and using the Raspberry Pi camera board to capture the images, it was obvious that using a full resolution image at 1080p was a bit too much to handle for the CPU, so instead I changed the resolution down to 320x240 and made it gray scale which made it able to capture at ~20 fps instead of 1-2 fps at the actual matching moment.</p>

<p>The matching is not on at all times, only when the middle part of the image becomes dark does it start to look for the cat snout. After the darkness has been detected the program saves 4 images in a row, if 2 of these are above the threshold the match is considered a success and the door will be left open. Otherwise the solenoid is turned on and the door is closed.</p>

<p>I also made it possible to run external programs at different important places in the code. For instance  on an RFID match, image recognition completing, or the images being saved. This makes it easy to add interactive behaviour to the system by writing small programs that for instance uploads the image to the internet.</p>

<p>Most of the testing was done without a live camera image, but here's a picture of my test setup when I tried it:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/testsetup01.jpg" alt="Cardboard">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/cardboard01.jpg" alt="Cardboard"></p>

<p>When developing this final program I needed to test it using the live Raspberry Pi camera to see if it matched OK. Trying to persuade my cat to walk through the corridor was not really an option though, so instead I printed a frame from my input video I had captured while bribing her with some cat candy, and then glued that on to some cardboard. This cut out could then be used to emulate the cat entering the corridor, which is very useful when fine tuning my program.</p>

<p>Here is the usage options of the final (as of writing) program:</p>

<div class="highlight highlight-source-shell"><pre>Catcierge Grabber v0.2.0 (C) Joakim Soderberg 2013-2014

Usage: ./catcierge_grabber [options]

 --snout <span class="pl-k">&lt;</span>paths<span class="pl-k">&gt;</span>        Path to the snout images to use. If more than one path is
                        given, the average match result is used.
 --threshold <span class="pl-k">&lt;</span>float<span class="pl-k">&gt;</span>    Match threshold as a value between 0.0 and 1.0. Default 0.8
 --lockout <span class="pl-k">&lt;</span>seconds<span class="pl-k">&gt;</span>    The <span class="pl-k">time</span> <span class="pl-k">in</span> seconds a lockout takes. Default 30s
 --lockout_error <span class="pl-k">&lt;</span>n<span class="pl-k">&gt;</span>    Number of lockouts <span class="pl-k">in</span> a row is allowed before we
                        consider it an error and quit the program.
                        Default is to never <span class="pl-k">do</span> this.
 --lockout_dummy        Do everything as normal, but don<span class="pl-s"><span class="pl-pds">'</span>t actually lock the door.</span>
<span class="pl-s">                        This is useful for testing.</span>
<span class="pl-s"> --matchtime &lt;seconds&gt;  The time to wait after a match. Default 0s</span>
<span class="pl-s"> --match_flipped &lt;0|1&gt;  Match a flipped version of the snout</span>
<span class="pl-s">                        (don<span class="pl-pds">'</span></span>t consider going out a failed match). Default on.
 --show                 Show GUI of the camera feed (X11 only).
 --show_fps <span class="pl-k">&lt;</span>0<span class="pl-k">|</span><span class="pl-k">1&gt;</span>       Show FPS. Default is ON.
 --save                 Save match images (both ok and failed).
 --highlight            Highlight the best match on saved images.
 --output <span class="pl-k">&lt;</span>path<span class="pl-k">&gt;</span>        Path to where the match images should be saved.
 --log <span class="pl-k">&lt;</span>path<span class="pl-k">&gt;</span>           Log matches and rfid readings (<span class="pl-k">if</span> enabled).
 --config <span class="pl-k">&lt;</span>path<span class="pl-k">&gt;</span>        Path to config file. Default is ./catcierge.cfg or /etc/catcierge.cfg
                        This is parsed as an INI file. The keys/values are the same as these options.

RFID:
 --rfid_in <span class="pl-k">&lt;</span>path<span class="pl-k">&gt;</span>       Path to inner RFID reader. Example: /dev/ttyUSB0
 --rfid_out <span class="pl-k">&lt;</span>path<span class="pl-k">&gt;</span>      Path to the outter RFID reader.
 --rfid_lock            Lock <span class="pl-k">if</span> no RFID tag present or invalid RFID tag. Default OFF.
 --rfid_time <span class="pl-k">&lt;</span>seconds<span class="pl-k">&gt;</span>  Number of seconds to <span class="pl-c1">wait</span> after a valid match before the
                        RFID readers are checked.
                        (This is so that there is enough <span class="pl-k">time</span> <span class="pl-k">for</span> <span class="pl-smi">the</span> cat to be <span class="pl-c1">read</span> by both readers)
 --rfid_allowed <span class="pl-k">&lt;</span>list<span class="pl-k">&gt;</span>  A comma separated list of allowed RFID tags. Example: 999_000000001007

Commands:
   (Note that %0, %1, %2... will be replaced <span class="pl-k">in</span> the input, see --cmdhelp <span class="pl-k">for</span> <span class="pl-smi">details</span>)
 --match_cmd <span class="pl-k">&lt;</span>cmd<span class="pl-k">&gt;</span>      Command to run after a match is made.
 --save_img_cmd <span class="pl-k">&lt;</span>cmd<span class="pl-k">&gt;</span>   Command to run at the moment a match image is saved.
 --save_imgs_cmd <span class="pl-k">&lt;</span>cmd<span class="pl-k">&gt;</span>  Command that runs when all match images have been saved to disk.
                        (This is most likely what you want to use <span class="pl-k">in</span> most cases)
 --match_done_cmd <span class="pl-k">&lt;</span>cmd<span class="pl-k">&gt;</span> Command to run when a match is <span class="pl-k">done</span>.
 --rfid_detect_cmd <span class="pl-k">&lt;</span>cmd<span class="pl-k">&gt;</span> Command to run when one of the RFID readers detects a tag.
 --rfid_match_cmd <span class="pl-k">&lt;</span>cmd<span class="pl-k">&gt;</span> Command that is run when a RFID match is made.
 --do_lockout_cmd <span class="pl-k">&lt;</span>cmd<span class="pl-k">&gt;</span> Command to run when the lockout should be performed.
                        This will override the normal lockout method.
 --do_unlock_cmd <span class="pl-k">&lt;</span>cmd<span class="pl-k">&gt;</span>  Command that is run when we should unlock.
                        This will override the normal unlock method.

 --help                 Show this <span class="pl-c1">help</span>.
 --cmdhelp              Show extra <span class="pl-c1">command</span> <span class="pl-c1">help</span>.

The snout image refers to the image of the cat snout that is matched against.
This image should be based on a 320x240 resolution image taken by the rpi camera.
If no path is specified <span class="pl-s"><span class="pl-pds">"</span>snout.png<span class="pl-pds">"</span></span> <span class="pl-k">in</span> the current directory is used.

Signals:
The program can receive signals that can be sent using the <span class="pl-c1">kill</span> <span class="pl-c1">command</span>.
 SIGUSR1 = Force the cat door to unlock
 SIGUSR2 = Force the cat door to lock (<span class="pl-k">for</span> <span class="pl-smi">lock</span> timeout)
</pre></div>

<h2>
<a id="finalizing-the-building" class="anchor" href="#finalizing-the-building" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finalizing the building</h2>

<p>After being satisfied with the software and that it works I started building the walls and roof on the cat door corridor.</p>

<p>From start I wanted the entire thing to be light enough for me to lift it around easily, so that I can take it inside if I want to work on it. For this reason I knew that both the walls and roof needed to be removable.</p>

<h2>
<a id="walls" class="anchor" href="#walls" aria-hidden="true"><span class="octicon octicon-link"></span></a>Walls</h2>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/wall01.jpg" alt="Final">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/vinkelbeslag01.jpg" alt="Final"></p>

<p>To make them removable I put two screws on the top of the frame. I then put two sash angles on each wall, the holes in the middle of these then match up to the screws on the frame. This arrangement enables me to hang the walls on the frame and remove them when necessary.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/wall02.jpg" alt="Final">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/wall03.jpg" alt="Final"></p>

<p>Here both walls are hung on the frame:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/wall04.jpg" alt="Final"></p>

<p>I decided to make the front non-removable since the entrance and everything would make it less convenient. And the extra weight isn't really a problem to be able to move it around anyway.</p>

<p>I also made a small roof just above the entrance so that I can put the RFID antenna under it. Plus it will keep rain and snow out.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/entrance01.jpg" alt="Final">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/entrance02.jpg" alt="Final"></p>

<h3>
<a id="roof" class="anchor" href="#roof" aria-hidden="true"><span class="octicon octicon-link"></span></a>Roof</h3>

<p>Finally I built the roof out of some plywood. To keep the water out I put some <a href="http://www.byggmax.com/sv-se/byggvaror/isolering/ovrig-isolering/syllpapp-p17065">"syllpapp"</a> on it (I don't know what it's called in English, but it's used as a moisture stop/isolation between concrete and wooden beams).</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/roof01.jpg" alt="Roof">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/roof02.jpg" alt="Roof">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/roof03.jpg" alt="Roof">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/roof04.jpg" alt="Roof"></p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p>Finally I could install the corridor. Note that the entire thing is standing on top of some garden tiles to get it a bit off the ground, so that it will stay dry as the snow melts.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/installation01.jpg" alt="Installation">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/installation02.jpg" alt="Installation">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/installation03.jpg" alt="Installation">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/installation04.jpg" alt="Installation"></p>

<h2>
<a id="testing-phase" class="anchor" href="#testing-phase" aria-hidden="true"><span class="octicon octicon-link"></span></a>Testing phase</h2>

<p>For the first time I was now hoping for Higgs to bring something in so I could verify the cat door was actually detecting correctly.</p>

<p>And finally it happened!... Except that it did not detect the mouse she had brought in successfully. Apparently my hand drawn test image was not realistic enough.</p>

<p>Here is two frames with the mouse in her mouth:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/real/fail01.png" alt="Test phase">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/real/fail02.png" alt="Test phase"></p>

<p>Here with the best match highlighted, with a match result of <strong>0.844146</strong> and <strong>0.837592</strong> respectivly. Which is well above the threshold of <strong>0.8</strong>.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/old_matcher/match_ok__fail01.png" alt="Test phase">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/old_matcher/match_ok__fail02.png" alt="Test phase"></p>

<p>However, I didn't think the solution was to raise the threshold, since some of the OK matches are not far enough from 0.84. Instead I think a better solution was to change what part of the cat snout is matched against.</p>

<p>The original snout that I used: </p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/snout/snout320x240.png" alt="Snout"></p>

<p>Instead I changed it to this one that includes some more area below the chin. You may notice it looks a bit squished compared to the first one. That's because I realized that the native image of the camera does not have a 4:3 aspect ratio, but rather 16:9. So my resolution of 320x240 was not really the correct aspect ratio, I should have used 320x180.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/snout/snout320x240_02.png" alt="Snout"></p>

<p>Match results for this new snout image with Higgs's victim in her mouth:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/new_matcher/match_fail__fail01.png" alt="Snout">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/new_matcher/match_fail__fail02.png" alt="Snout"></p>

<p>Here is a comparison of all the good matches since I started testing until Higgs first delivery. As you can see, the new matcher fails in some cases. This is not much of an issue though, because it only happens at the edge pictures. This normally will fail anyway since the snout is most often completely outside the frame.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/new_matcher/new_matcher.gif" alt="Snout">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/example/old_matcher/old_matcher.gif" alt="Snout"></p>

<h2>
<a id="continued-test-phase" class="anchor" href="#continued-test-phase" aria-hidden="true"><span class="octicon octicon-link"></span></a>Continued test phase</h2>

<h3>
<a id="cold" class="anchor" href="#cold" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cold</h3>

<p>Of course the change mentioned above didn't solve all my problems. All my testing so far had either been done inside, or when the temperature was around -5C... Then when the temperature started going down to around -30C in January I got this:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/coldcam01.png" alt="Cold"></p>

<p>... which resulted in a spam of "lockouts" happening because the program thought something was blocking the frame. I realised what the source of the problem was right away, since the Raspberry Pi camera isn't rated to work in subzero temperatures (The Raspberry Pi itself had no problems however).</p>

<p>So I had to find a solution for this. The part of the cat house the camera is in, isn't isolated, so warming all of it was out of the question. Instead I decided to build a small box with a window for the camera, and some power resistors + a thermostat to keep it warm. I bought a really crappy 12V thermostat kit at the local electronics shop that did the job (however I've already bought a new one on ebay that will replace it):</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/heater01.jpg" alt="Cold">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/heater02.jpg" alt="Cold">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/heater03.jpg" alt="Cold">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/heater04.jpg" alt="Cold">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/heater06.jpg" alt="Cold">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/termostat01.jpg" alt="Cold"></p>

<h3>
<a id="darkness" class="anchor" href="#darkness" aria-hidden="true"><span class="octicon octicon-link"></span></a>Darkness</h3>

<p>After fixing the cold problem, everything worked well for about a week, until suddenly my homemade backlight went dark. When stuff like this happens I'm glad I decided to make everything removable, so I could simply remove the wall and remove the backlight to examine it. </p>

<p>I took it inside and realised that the sharp bends I made in my original backlight had made the waterproofing crack in the cold. At first I thought this was the reason for it going black. Later it turned out it actually was a glitchy wiring job in the cat house itself.... Anyway I remade the thing more properly without bending the led strips and instead soldering them together, and finally hot gluing it all:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/newbacklight01.jpg" alt="Cold">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/newbacklight02.jpg" alt="Cold"></p>

<h3>
<a id="bugs-and-other-issues" class="anchor" href="#bugs-and-other-issues" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bugs and other issues</h3>

<p>There wasn't only hardware problems that gave me problems however. I also had a bunch of software bugs, mostly due to the fact that I hacked this together as I went, and didn't really have a very coherent design from the start. I tried to clean things up a bit at least by creating a state machine diagram to make the transitions made by the program a lot more clear cut:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/doc/catcierge_state.png" alt="state"></p>

<h2>
<a id="improved-algorithm" class="anchor" href="#improved-algorithm" aria-hidden="true"><span class="octicon octicon-link"></span></a>Improved algorithm</h2>

<p>The algorithm improvements mentioned above only helped so far. I soon realised that simply matching against a single tweaked image of the cat snout wasn't enough, so instead I got the idea of using multiple snout images for the match and deciding on the average of their match result.</p>

<p>I updated my python prototype to test this hypothesis using all the accumulated input pictures so far. Testing a bunch of different combinations of snout images, I soon came to the conclusion that 2 was enough. The best results that I got was using these two images:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/snout/snout320x240.png" alt="double">
<img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/snout/snout320x240_04b.png" alt="double"></p>

<p>One that focuses on only chin area, and one modified image that matches the entire head. To determine that these where the best, I ran the prototype program on a bunch of the input images I had and tried to find the combination that reject all images with mice in the cats mouth, and didn't reject the normal ones. Here's such a montage for the pictures above:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/montage01.jpg" alt="double"></p>

<h1>
<a id="haar-matcher" class="anchor" href="#haar-matcher" aria-hidden="true"><span class="octicon octicon-link"></span></a>Haar matcher</h1>

<p>So after evaluating and tweaking the template matcher, I decided to try a more advanced method using Haar Cascades (a very common method used for facial recognition).</p>

<p>I might go more into the details in the future, but this approach is a lot faster than the template matcher, as well as more successful. The main idea is that the Haar Cascade is trained to find the cat head in an image. Then after the head has been found, it looks at the lower portion of the cats face, to see if something is "hanging down" below the chin (most likely prey!).</p>

<p>Here's an example of how an image is processed:</p>

<p><img src="https://raw.githubusercontent.com/JoakimSoderberg/catcierge-examples/master/example/haar_matcher/catcierge_haar_steps.png" alt="Haarsteps"></p>

<h1>
<a id="funny-pictures" class="anchor" href="#funny-pictures" aria-hidden="true"><span class="octicon octicon-link"></span></a>Funny pictures</h1>

<p>If you've read this far you should be rewarded with some funny pictures!</p>

<h2>
<a id="kamikaze-bird" class="anchor" href="#kamikaze-bird" aria-hidden="true"><span class="octicon octicon-link"></span></a>Kamikaze bird</h2>

<p>This one I really don't understand... Remember that these images are all taken within 1 second. So it looks like the bird is chasing the cat:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/kamikaze01.jpg" alt="kamikaze"> </p>

<p>However, a more likely scenario is that this is due to a software bug, and that the bird came soon after, not knowing this was a cat house.</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/kamikaze02.jpg" alt="kamikaze"></p>

<p>Here my wife went to investigate, and waved to me at the same time... She did not see any bird (!?):</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/kamikaze03.jpg" alt="kamikaze"> </p>

<h2>
<a id="squirrel" class="anchor" href="#squirrel" aria-hidden="true"><span class="octicon octicon-link"></span></a>Squirrel</h2>

<p>Birds aren't the only curious little creatures investigating the premises:</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/squirrel01.jpg" alt="kamikaze"></p>

<p>Bye bye for now!</p>

<p><img src="https://raw.github.com/JoakimSoderberg/catcierge-examples/master/diy/higgsthegreat.jpg" alt="kamikaze"> </p>
        </section>

        <footer>
          Catcierge is maintained by <a href="https://github.com/JoakimSoderberg">JoakimSoderberg</a><br>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

                  <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-46907210-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

      </div>
    </div>
  </body>
</html>
